<h2>Activated Repositories</h2>

<button id="toggle-grouped" class="outline small" onclick="toggleGroupedView()" style="margin-bottom: 0.5rem;">Group by Category</button>

<table class="repos-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>User</th>
            <th>Golden Repo</th>
            <th>Category</th>
            <th>Indexes</th>
            <th>Activated Date</th>
            <th>File Count</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% if repos %}
        {% for repo in repos %}
        <tr data-repo-alias="{{ repo.user_alias }}" data-category-id="{{ repo.category_id or '' }}" data-category-name="{{ repo.category_name or 'Unassigned' }}" data-category-priority="{{ repo.category_priority if repo.category_priority is not none else 999999 }}">
            <td>
                <a href="#" onclick="toggleDetails('{{ repo.username }}', '{{ repo.user_alias }}'); return false;">
                    {{ repo.user_alias }}
                </a>
            </td>
            <td>{{ repo.username }}</td>
            <td>{{ repo.golden_repo_alias or 'Composite' }}</td>
            <td>{{ repo.category_name or 'Unassigned' }}</td>
            <td class="indexes-cell" style="white-space: nowrap;">
                <span id="index-badges-{{ repo.username }}-{{ repo.user_alias }}" data-owner="{{ repo.username }}" data-alias="{{ repo.user_alias }}">
                    <span class="no-indexes">Loading...</span>
                </span>
            </td>
            <td>{{ repo.activated_at[:10] if repo.activated_at else 'N/A' }}</td>
            <td>{{ repo.file_count if repo.file_count is defined else 'N/A' }}</td>
            <td class="status-cell">
                {% if repo.status == 'syncing' %}
                <span class="status-indicator status-syncing" title="Syncing in progress">
                    <span class="spinner"></span> Syncing
                </span>
                {% elif repo.status == 'error' %}
                <span class="status-indicator status-error" title="Error: {{ repo.error_message }}">
                    Error
                </span>
                {% else %}
                <span class="status-indicator status-active">
                    Active
                </span>
                {% endif %}
            </td>
            <td class="actions-cell">
                <button class="outline small" onclick="toggleDetails('{{ repo.username }}', '{{ repo.user_alias }}')" title="View details">Details</button>
                <button class="small" onclick="triggerActivatedRepoReindex('{{ repo.user_alias }}')" title="Re-index repository">Reindex</button>
                <button class="outline small danger" onclick="confirmDeactivate('{{ repo.username }}', '{{ repo.user_alias }}')" title="Deactivate repository">Deactivate</button>
            </td>
        </tr>

        <!-- Details Row (hidden by default) -->
        <tr id="details-{{ repo.username }}-{{ repo.user_alias }}" class="details-row" style="display: none;">
            <td colspan="9">
                <article class="repo-details">
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Name:</label>
                            <span>{{ repo.user_alias }}</span>
                        </div>
                        <div class="detail-item">
                            <label>User:</label>
                            <span>{{ repo.username }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Golden Repo Source:</label>
                            <span>{{ repo.golden_repo_alias or 'Composite Repository' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Activation Timestamp:</label>
                            <span>{{ repo.activated_at or 'N/A' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Current Branch:</label>
                            <span>{{ repo.current_branch or 'N/A' }}</span>
                        </div>
                        <div class="detail-item">
                            <label>Last Accessed:</label>
                            <span>{{ repo.last_accessed or 'N/A' }}</span>
                        </div>
                        {% if repo.file_count is defined %}
                        <div class="detail-item">
                            <label>File Count:</label>
                            <span>{{ repo.file_count }}</span>
                        </div>
                        {% endif %}
                        {% if repo.chunk_count is defined %}
                        <div class="detail-item">
                            <label>Chunk Count:</label>
                            <span>{{ repo.chunk_count }}</span>
                        </div>
                        {% endif %}
                        {% if repo.last_query_at is defined %}
                        <div class="detail-item">
                            <label>Last Query Timestamp:</label>
                            <span>{{ repo.last_query_at or 'Never' }}</span>
                        </div>
                        {% endif %}
                        <div class="detail-item">
                            <label>Status:</label>
                            <span>{{ repo.status or 'Active' }}</span>
                        </div>
                        {% if repo.is_composite %}
                        <div class="detail-item">
                            <label>Type:</label>
                            <span>Composite Repository</span>
                        </div>
                        <div class="detail-item">
                            <label>Component Repos:</label>
                            <span>{{ repo.golden_repo_aliases | join(', ') if repo.golden_repo_aliases else 'N/A' }}</span>
                        </div>
                        {% endif %}
                        {% if repo.error_message %}
                        <div class="detail-item error-details">
                            <label>Error:</label>
                            <span class="error-text">{{ repo.error_message }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Activated Repository Management Section (Story #160) -->
                    <div class="activated-repo-management">
                        <h4>Repository Management</h4>

                        <!-- Indexes Management -->
                        <div class="indexes-management">
                            <h5>Indexes</h5>
                            <div class="indexes-status-grid">
                                <div class="index-status-item">
                                    <label>Semantic:</label>
                                    <span class="index-status" id="index-status-semantic-{{ repo.user_alias }}">
                                        <span class="status-icon not-present">-</span> <span class="status-text">Loading...</span>
                                    </span>
                                </div>
                                <div class="index-status-item">
                                    <label>FTS (Full-Text Search):</label>
                                    <span class="index-status" id="index-status-fts-{{ repo.user_alias }}">
                                        <span class="status-icon not-present">-</span> <span class="status-text">Loading...</span>
                                    </span>
                                </div>
                                <div class="index-status-item">
                                    <label>Temporal (Git History):</label>
                                    <span class="index-status" id="index-status-temporal-{{ repo.user_alias }}">
                                        <span class="status-icon not-present">-</span> <span class="status-text">Loading...</span>
                                    </span>
                                </div>
                                <div class="index-status-item">
                                    <label>SCIP (Code Intelligence):</label>
                                    <span class="index-status" id="index-status-scip-{{ repo.user_alias }}">
                                        <span class="status-icon not-present">-</span> <span class="status-text">Loading...</span>
                                    </span>
                                </div>
                            </div>

                            <!-- Add Index Button and Form -->
                            <div class="add-index-container" id="add-index-container-{{ repo.user_alias }}">
                                <button class="outline small" onclick="showActivatedRepoAddIndexForm('{{ repo.user_alias }}')">Add Index</button>

                                <div id="add-index-form-{{ repo.user_alias }}" class="add-index-form" style="display: none;">
                                    <label for="add-index-type-{{ repo.user_alias }}">Select Index Type:</label>
                                    <select id="add-index-type-{{ repo.user_alias }}" name="index_type">
                                        <option value="">-- Select Index Type --</option>
                                        <option value="semantic">Semantic</option>
                                        <option value="fts">FTS (Full-Text Search)</option>
                                        <option value="temporal">Temporal (Git History)</option>
                                        <option value="scip">SCIP (Code Intelligence)</option>
                                    </select>
                                    <div class="form-actions">
                                        <button class="small" onclick="submitActivatedRepoAddIndex('{{ repo.user_alias }}')">Submit</button>
                                        <button class="outline small" onclick="hideActivatedRepoAddIndexForm('{{ repo.user_alias }}')">Cancel</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Progress Container -->
                            <div id="job-progress-{{ repo.user_alias }}" class="job-progress-container" style="display: none;">
                                <div class="job-progress-header">
                                    <span class="job-status-text">Job Status: <span id="job-status-text-{{ repo.user_alias }}">pending</span></span>
                                    <span class="spinner" id="job-spinner-{{ repo.user_alias }}"></span>
                                </div>
                                <div class="job-progress-details" id="job-progress-details-{{ repo.user_alias }}"></div>
                            </div>
                        </div>

                        <!-- Branch Management -->
                        <div class="branch-management" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                            <h5>Branch Management</h5>
                            <div class="branch-actions">
                                <button class="outline small" onclick="showBranchSelector('{{ repo.user_alias }}')" title="Switch to different branch">Switch Branch</button>
                                <button class="outline small" onclick="syncWithGoldenRepo('{{ repo.user_alias }}')" title="Sync with golden repository source">Sync with Golden</button>
                            </div>
                        </div>

                        <!-- Health Status Section -->
                        <div class="health-status-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                            <div class="health-header">
                                <h5>HNSW Index Health</h5>
                                <button
                                    id="health-refresh-{{ repo.user_alias }}"
                                    class="outline small"
                                    onclick="refreshActivatedRepoHealthData('{{ repo.user_alias }}', '{{ repo.username }}')"
                                    title="Refresh health data (bypass cache)"
                                >
                                    Refresh
                                </button>
                            </div>

                            <!-- Health Status Indicator -->
                            <div
                                id="health-indicator-{{ repo.user_alias }}"
                                class="health-indicator-container"
                                onclick="toggleActivatedRepoHealthDetails('{{ repo.user_alias }}', '{{ repo.username }}')"
                                style="cursor: pointer;"
                            >
                                <span class="health-status health-unknown">Deep health check</span>
                            </div>

                            <!-- Detailed Health Check Results -->
                            <div
                                id="health-details-{{ repo.user_alias }}"
                                class="health-details-container"
                                style="display: none;"
                                data-loaded="false"
                            >
                                <!-- Details loaded dynamically via JavaScript -->
                            </div>
                        </div>
                    </div>
                </article>
            </td>
        </tr>

        <!-- Deactivate Form (hidden) -->
        <form id="deactivate-form-{{ repo.username }}-{{ repo.user_alias }}" method="post" action="/admin/repos/{{ repo.username }}/{{ repo.user_alias }}/deactivate" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        </form>
        {% endfor %}
        {% else %}
        <tr>
            <td colspan="9" class="no-data">No activated repositories. Users can activate repositories from golden repos.</td>
        </tr>
        {% endif %}
    </tbody>
</table>

<script src="/admin/static/js/repo_categories.js"></script>
<script>applyStoredGroupedView();</script>

{% if total_pages is defined and total_pages > 1 %}
<!-- Pagination -->
<nav class="pagination">
    <ul>
        {% if page > 1 %}
        <li>
            <a href="/admin/repos?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if golden_repo_filter %}&golden_repo={{ golden_repo_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}">&laquo; Previous</a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
        <li>
            <a href="/admin/repos?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if golden_repo_filter %}&golden_repo={{ golden_repo_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}" {% if p == page %}aria-current="page"{% endif %}>{{ p }}</a>
        </li>
        {% endfor %}

        {% if page < total_pages %}
        <li>
            <a href="/admin/repos?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if golden_repo_filter %}&golden_repo={{ golden_repo_filter }}{% endif %}{% if user_filter %}&user={{ user_filter }}{% endif %}">Next &raquo;</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Branch Selector Modal -->
<dialog id="branch-selector-modal">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="closeBranchSelector()"></button>
            <h3>Select Branch</h3>
        </header>
        <div id="branch-loading" style="display: none;">
            <span class="spinner"></span> Loading branches...
        </div>
        <div id="branch-error" style="display: none;"></div>
        <ul id="branch-list" style="list-style: none; padding: 0;"></ul>
        <footer>
            <button class="secondary" onclick="closeBranchSelector()">Cancel</button>
        </footer>
    </article>
</dialog>

<style>
.index-badge {
    display: inline-block;
    padding: 2px 6px;
    margin: 1px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}
.index-badge.semantic {
    background-color: #e3f2fd;
    color: #1565c0;
}
.index-badge.fts {
    background-color: #f3e5f5;
    color: #7b1fa2;
}
.index-badge.temporal {
    background-color: #fff3e0;
    color: #e65100;
}
.index-badge.scip {
    background-color: #e8f5e9;
    color: #2e7d32;
}
.no-indexes {
    color: #999;
    font-style: italic;
}
.activated-repo-management {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e0e0e0;
}
.indexes-management h5,
.branch-management h5,
.health-status-section h5 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}
.indexes-status-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}
.index-status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
}
.index-status-item label {
    margin: 0;
    font-weight: 500;
}
.index-status .status-icon.present {
    color: var(--pico-color-green-550);
}
.index-status .status-icon.not-present {
    color: #999;
}
.add-index-container {
    margin-top: 0.5rem;
}
.add-index-form {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #f5f5f5;
    border-radius: 4px;
}
.add-index-form label {
    display: block;
    margin-bottom: 0.25rem;
}
.add-index-form select {
    width: 100%;
    margin-bottom: 0.5rem;
}
.branch-actions {
    display: flex;
    gap: 0.5rem;
}
.job-progress-container {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #f9f9f9;
    border-radius: 4px;
    border: 1px solid #e0e0e0;
}
.job-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.job-status-text {
    font-weight: 500;
}
.job-progress-details {
    font-size: 0.9rem;
}
.health-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.health-indicator-container {
    padding: 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}
.health-details-container {
    margin-top: 0.5rem;
}
#branch-list li {
    margin-bottom: 0.5rem;
}
#branch-list button {
    width: 100%;
}
</style>

<script>
// Track open add-index forms for HTMX refresh preservation
let openActivatedRepoAddIndexForms = new Set();
let openActivatedRepoHealthDetails = new Set();

// Load index status on page load for all visible repos
document.addEventListener('DOMContentLoaded', function() {
    loadAllActivatedRepoIndexes();
});

// Reload index status after HTMX content replacement
document.body.addEventListener('htmx:afterSettle', function(event) {
    const target = event.detail.target;
    if (target && target.id === 'repos-list-section') {
        requestAnimationFrame(() => {
            loadAllActivatedRepoIndexes();
            restoreOpenActivatedRepoAddIndexForms();
            restoreOpenActivatedRepoHealthDetails();
        });
    }
});

/**
 * Load index status for all activated repositories on the page
 */
function loadAllActivatedRepoIndexes() {
    const badges = document.querySelectorAll('[id^="index-badges-"]');
    badges.forEach(async (badge) => {
        const owner = badge.dataset.owner;  // Get owner from data-owner attribute
        const userAlias = badge.dataset.alias;  // Get alias from data-alias attribute
        const badgeId = `${owner}-${userAlias}`;  // Unique identifier for this repo
        try {
            const indexData = await fetchActivatedRepoIndexes(userAlias, owner);
            updateIndexBadges(badgeId, indexData);
            // Note: updateIndexStatusGrid uses different IDs (just userAlias),
            // so we update it separately when details are expanded
        } catch (error) {
            console.error(`Failed to load indexes for ${owner}/${userAlias}:`, error);
            badge.innerHTML = '<span class="no-indexes">Error</span>';
        }
    });
}

/**
 * Update index status grid to show error/not-available state
 */
function updateIndexStatusGridError(userAlias) {
    const indexTypes = ['semantic', 'fts', 'temporal', 'scip'];
    indexTypes.forEach(type => {
        const statusSpan = document.getElementById(`index-status-${type}-${userAlias}`);
        if (statusSpan) {
            statusSpan.innerHTML = '<span class="status-icon not-present">-</span> <span class="status-text">N/A</span>';
        }
    });
}

/**
 * Update index status grid in details section
 */
function updateIndexStatusGrid(userAlias, indexData) {
    const indexTypes = ['semantic', 'fts', 'temporal', 'scip'];

    // Convert API response format (indexes array) to lookup object
    // API returns: {indexes: [{index_type: "semantic", exists: true}, ...]}
    const indexExists = {};
    if (indexData.indexes && Array.isArray(indexData.indexes)) {
        indexData.indexes.forEach(idx => {
            indexExists[idx.index_type] = idx.exists;
        });
    } else {
        // Fallback for legacy flat format
        indexTypes.forEach(type => {
            indexExists[type] = indexData[`has_${type}`] || false;
        });
    }

    indexTypes.forEach(type => {
        const statusSpan = document.getElementById(`index-status-${type}-${userAlias}`);
        if (statusSpan) {
            const hasIndex = indexExists[type];
            statusSpan.innerHTML = hasIndex
                ? '<span class="status-icon present">âœ“</span> <span class="status-text">Present</span>'
                : '<span class="status-icon not-present">-</span> <span class="status-text">Not Present</span>';
        }
    });
}

/**
 * Restore open add-index forms after HTMX refresh
 */
function restoreOpenActivatedRepoAddIndexForms() {
    console.log('[CIDX] restoreOpenActivatedRepoAddIndexForms() called');
    console.log('[CIDX] openActivatedRepoAddIndexForms size:', openActivatedRepoAddIndexForms.size);

    if (openActivatedRepoAddIndexForms.size > 0) {
        openActivatedRepoAddIndexForms.forEach(userAlias => {
            const form = document.getElementById(`add-index-form-${userAlias}`);
            if (form) {
                form.style.display = 'block';
                console.log('[CIDX] Restored add-index form for:', userAlias);
            }
        });
    }
}

/**
 * Restore open health details panels after HTMX refresh
 */
function restoreOpenActivatedRepoHealthDetails() {
    console.log('[CIDX] restoreOpenActivatedRepoHealthDetails() called');
    console.log('[CIDX] openActivatedRepoHealthDetails size:', openActivatedRepoHealthDetails.size);

    openActivatedRepoHealthDetails.forEach(userAlias => {
        const detailsContainer = document.getElementById(`health-details-${userAlias}`);
        const indicator = document.getElementById(`health-indicator-${userAlias}`);

        if (detailsContainer) {
            detailsContainer.style.display = 'block';
            if (indicator) {
                indicator.classList.add('expanded');
            }
            detailsContainer.dataset.loaded = 'false';
            loadActivatedRepoHealthDetails(userAlias, false).then(() => {
                console.log('[CIDX] Health details reloaded for:', userAlias);
            }).catch(err => {
                console.error('[CIDX] Failed to reload health details for:', userAlias, err);
            });
        }
    });
}
</script>
