<!-- Story #212: Dependency Map Job Status Partial -->
<!-- AC5: HTMX auto-refresh every 5s when status=running -->
<div id="depmap-job-status-content"
     {% if job_status.status == "running" %}
     hx-get="/admin/partials/depmap-job-status"
     hx-trigger="every 5s"
     hx-swap="outerHTML"
     hx-target="#depmap-job-status-content"
     {% endif %}>

<h2>Job Status</h2>

<!-- AC3: Health badge with color -->
{% set color_class_map = {
    'GREEN':  'status-healthy',
    'YELLOW': 'status-degraded',
    'RED':    'status-unhealthy',
    'BLUE':   'status-running',
    'GRAY':   'status-disabled'
} %}
<div class="health-grid">
    <article class="health-card">
        <header>
            <h3>Health</h3>
        </header>
        <div class="status-content">
            <span class="status-indicator {{ color_class_map.get(job_status.color, 'status-disabled') }}"></span>
            <span class="status-text">{{ job_status.health }}</span>
        </div>
        <footer>
            <small>Status: {{ job_status.status or "unknown" }}</small>
        </footer>
    </article>

    <!-- AC2: Timestamps -->
    <article class="health-card">
        <header>
            <h3>Schedule</h3>
        </header>
        <div class="system-metrics">
            <div class="metric">
                <span class="metric-label">Last Run</span>
                <span class="metric-value" style="white-space: nowrap;">
                    {% if job_status.last_run %}
                        {{ job_status.last_run[:16] | replace("T", " ") }}
                    {% else %}
                        Never
                    {% endif %}
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">Next Run</span>
                <span class="metric-value" style="white-space: nowrap;">
                    {% if job_status.next_run %}
                        {{ job_status.next_run[:16] | replace("T", " ") }}
                    {% else %}
                        Not scheduled
                    {% endif %}
                </span>
            </div>
        </div>
    </article>

    <!-- AC6: Run Now dropdown (admin context - this partial is admin-only) -->
    <article class="health-card">
        <header>
            <h3>Actions</h3>
        </header>
        <div style="padding: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;">
            <div style="display: flex; gap: 0.5rem;">
                <button hx-post="/admin/dependency-map/trigger"
                        hx-vals='{"mode": "full"}'
                        hx-swap="none"
                        style="flex: 1; font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                    Full Analysis
                </button>
                <button class="secondary"
                        hx-post="/admin/dependency-map/trigger"
                        hx-vals='{"mode": "delta"}'
                        hx-swap="none"
                        style="flex: 1; font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                    Delta Refresh
                </button>
            </div>
            <div id="depmap-trigger-status" style="font-size: 0.9rem;"></div>
        </div>
    </article>
</div>

<!-- Story #329: Activity Journal Panel - shown when running or when progress_info is set -->
{% if job_status.status == "running" or job_status.get("progress_info") %}
<article id="depmap-activity-panel" style="margin-top: 1rem;">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Activity Journal</h3>
            <span id="depmap-progress-text"
                  style="font-size: 0.85rem; color: var(--pico-muted-color);">
                {{ job_status.get("progress_info", "") }}
            </span>
        </div>
        <!-- Progress bar -->
        <div style="margin-top: 0.5rem; background: var(--pico-secondary-background);
                    border-radius: 4px; height: 8px; overflow: hidden;">
            <div id="depmap-progress-bar"
                 style="height: 100%; background: var(--pico-primary);
                        border-radius: 4px; transition: width 0.3s ease;
                        width: {{ job_status.get('progress', 0) or 0 }}%;">
            </div>
        </div>
        <div style="text-align: right; font-size: 0.75rem;
                    color: var(--pico-muted-color); margin-top: 2px;">
            <span id="depmap-progress-pct">{{ job_status.get("progress", 0) or 0 }}%</span>
        </div>
    </header>

    <!-- Scrolling journal entries -->
    <div id="depmap-journal-scroll"
         style="max-height: 400px; overflow-y: auto; padding: 0.5rem;
                font-family: monospace; font-size: 0.8rem; line-height: 1.5;
                background: var(--pico-card-background-color); border-radius: 4px;">
        <div id="depmap-activity-entries"
             hx-get="/admin/partials/depmap-activity-journal?offset=0"
             hx-trigger="every 5s"
             hx-swap="beforeend">
        </div>
    </div>
</article>
{% endif %}

<!-- AC4: Error banner - only shown when status=failed and error_message non-empty -->
{% if job_status.status == "failed" and job_status.error_message %}
<article style="border-left: 4px solid var(--pico-color-red-550); margin-top: 1rem; padding: 1rem;">
    <header>
        <strong style="color: var(--pico-color-red-550);">Analysis Error</strong>
    </header>
    <!-- Jinja2 auto-escaping prevents XSS (AC4) -->
    <p>{{ job_status.error_message }}</p>
</article>
{% endif %}

<!-- AC9 (Story #216): Run history metrics table -->
{% if job_status.run_history %}
<article style="margin-top: 1rem;">
    <header>
        <h3>Recent Run Metrics</h3>
    </header>
    <div style="overflow-x: auto;">
        <table style="font-size: 0.85rem; margin-bottom: 0;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Domains</th>
                    <th>Chars</th>
                    <th>Edges</th>
                    <th>Repos</th>
                    <th>P1 (s)</th>
                    <th>P2 (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for run in job_status.run_history %}
                <tr>
                    <td style="white-space: nowrap;">
                        {% if run.timestamp %}{{ run.timestamp[:16] | replace("T", " ") }}{% else %}-{% endif %}
                    </td>
                    <td>{{ run.domain_count or 0 }}</td>
                    <td>{{ run.total_chars or 0 }}</td>
                    <td>{{ run.edge_count or 0 }}</td>
                    <td>{{ run.repos_analyzed or 0 }}</td>
                    <td>{{ "%.1f"|format(run.pass1_duration_s or 0) }}</td>
                    <td>{{ "%.1f"|format(run.pass2_duration_s or 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</article>
{% endif %}

</div>

<script>
// Handle Run Now trigger response
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.elt.hasAttribute('hx-post') &&
        evt.detail.elt.getAttribute('hx-post') === '/admin/dependency-map/trigger') {
        const statusDiv = document.getElementById('depmap-trigger-status');
        if (!statusDiv) return;

        if (evt.detail.successful) {
            statusDiv.innerHTML = '<span style="color: var(--pico-color-green-550);">Analysis triggered</span>';

            // Story #329: Reset journal and offset on new analysis trigger
            var entriesEl = document.getElementById('depmap-activity-entries');
            if (entriesEl) {
                entriesEl.innerHTML = '';
                entriesEl.setAttribute('hx-get', '/admin/partials/depmap-activity-journal?offset=0');
                htmx.process(entriesEl);
            }

            // Refresh job status after 3 seconds
            setTimeout(function() {
                htmx.ajax('GET', '/admin/partials/depmap-job-status', {
                    target: '#depmap-job-status',
                    swap: 'innerHTML'
                });
            }, 3000);
        } else {
            statusDiv.innerHTML = '<span style="color: var(--pico-color-red-550);">Failed to trigger analysis</span>';
        }

        // Clear status after 8 seconds
        setTimeout(function() {
            statusDiv.innerHTML = '';
        }, 8000);
    }

    // Story #329: Handle journal polling response - update offset and progress
    var path = evt.detail.pathInfo && evt.detail.pathInfo.requestPath;
    if (path && path.indexOf('depmap-activity-journal') !== -1) {
        var xhr = evt.detail.xhr;
        var newOffset = xhr.getResponseHeader('X-Journal-Offset');
        var progressPct = xhr.getResponseHeader('X-Journal-Progress');
        var progressInfo = xhr.getResponseHeader('X-Journal-Progress-Info');

        // Update offset for next poll
        if (newOffset) {
            var entriesEl = document.getElementById('depmap-activity-entries');
            if (entriesEl) {
                entriesEl.setAttribute('hx-get',
                    '/admin/partials/depmap-activity-journal?offset=' + newOffset);
                htmx.process(entriesEl);
            }
        }

        // Update progress bar and percentage text
        if (progressPct) {
            var bar = document.getElementById('depmap-progress-bar');
            if (bar) bar.style.width = progressPct + '%';
            var pct = document.getElementById('depmap-progress-pct');
            if (pct) pct.textContent = progressPct + '%';
        }

        // Update progress info text
        if (progressInfo) {
            var info = document.getElementById('depmap-progress-text');
            if (info) info.textContent = decodeURIComponent(progressInfo);
        }
    }
});

// Story #329: Auto-scroll journal when near bottom
// Fix M1: Capture scroll state BEFORE HTMX swap to avoid race condition where
// scrollHeight has already increased by the time MutationObserver fires.
(function() {
    var scrollContainer = document.getElementById('depmap-journal-scroll');
    if (!scrollContainer) return;

    var SCROLL_THRESHOLD = 50;
    var wasNearBottom = true;

    function isNearBottom() {
        return scrollContainer.scrollHeight - scrollContainer.scrollTop
               - scrollContainer.clientHeight < SCROLL_THRESHOLD;
    }

    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'depmap-activity-entries') {
            wasNearBottom = isNearBottom();
        }
    });

    var observer = new MutationObserver(function() {
        if (wasNearBottom) {
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }
    });

    var entriesContainer = document.getElementById('depmap-activity-entries');
    if (entriesContainer) {
        observer.observe(entriesContainer, { childList: true, subtree: true });
    }
})();
</script>
