{% extends "base.html" %}

{% block title %}Jobs - CIDX Admin{% endblock %}

{% block content %}
<div class="jobs-header">
    <h1>Job Monitoring</h1>
    <div class="jobs-actions">
        <button
            id="refresh-btn"
            class="outline"
            hx-get="/admin/partials/jobs-list"
            hx-target="#jobs-list-section"
            hx-swap="innerHTML"
            hx-indicator="#refresh-indicator"
            hx-include="#filter-form"
        >
            Refresh
        </button>
        <span id="refresh-indicator" class="htmx-indicator">Loading...</span>
    </div>
</div>

<!-- Queue Status Display -->
<section id="queue-status-section" class="queue-status-section">
    <div class="queue-status-grid">
        <div class="queue-status-item">
            <span class="status-label">Running Jobs</span>
            <span class="status-value status-running-count">{{ queue_status.running_count }}</span>
        </div>
        <div class="queue-status-item">
            <span class="status-label">Queued Jobs</span>
            <span class="status-value status-queued-count">{{ queue_status.queued_count }}</span>
        </div>
        <div class="queue-status-item">
            <span class="status-label">Max Concurrent (System)</span>
            <span class="status-value">{{ queue_status.max_total_concurrent_jobs }}</span>
        </div>
        <div class="queue-status-item">
            <span class="status-label">Max Per User</span>
            <span class="status-value">{{ queue_status.max_concurrent_jobs_per_user }}</span>
        </div>
    </div>
</section>

<!-- Success/Error Messages -->
{% if success_message %}
<article class="message-success">
    <p>{{ success_message }}</p>
</article>
{% endif %}

{% if error_message %}
<article class="message-error">
    <p>{{ error_message }}</p>
</article>
{% endif %}

<!-- Filters Section -->
<section id="filters-section" class="filters-section">
    <form id="filter-form" method="get" action="/admin/jobs">
        <div class="filter-row">
            <div class="filter-item">
                <label for="status_filter">Status</label>
                <select
                    id="status_filter"
                    name="status_filter"
                    hx-get="/admin/partials/jobs-list"
                    hx-target="#jobs-list-section"
                    hx-swap="innerHTML"
                    hx-trigger="change"
                    hx-include="#filter-form"
                >
                    <option value="">All Status</option>
                    <option value="queued" {% if status_filter == 'queued' %}selected{% endif %}>Queued</option>
                    <option value="running" {% if status_filter == 'running' %}selected{% endif %}>Running</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>Failed</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>

            <div class="filter-item">
                <label for="job_type">Type</label>
                <select
                    id="job_type"
                    name="job_type"
                    hx-get="/admin/partials/jobs-list"
                    hx-target="#jobs-list-section"
                    hx-swap="innerHTML"
                    hx-trigger="change"
                    hx-include="#filter-form"
                >
                    <option value="">All Types</option>
                    <option value="add_golden_repo" {% if type_filter == 'add_golden_repo' %}selected{% endif %}>Add Golden Repo</option>
                    <option value="remove_golden_repo" {% if type_filter == 'remove_golden_repo' %}selected{% endif %}>Remove Golden Repo</option>
                    <option value="refresh_golden_repo" {% if type_filter == 'refresh_golden_repo' %}selected{% endif %}>Refresh Golden Repo</option>
                    <option value="global_repo_refresh" {% if type_filter == 'global_repo_refresh' %}selected{% endif %}>Global Repo Refresh (Scheduled)</option>
                    <option value="add_index" {% if type_filter == 'add_index' %}selected{% endif %}>Add Index</option>
                    <option value="sync_repository" {% if type_filter == 'sync_repository' %}selected{% endif %}>Sync Repository</option>
                    <option value="activate_repository" {% if type_filter == 'activate_repository' %}selected{% endif %}>Activate Repo</option>
                    <option value="deactivate_repository" {% if type_filter == 'deactivate_repository' %}selected{% endif %}>Deactivate Repo</option>
                </select>
            </div>

            <div class="filter-item">
                <label for="search">Search</label>
                <input
                    type="search"
                    id="search"
                    name="search"
                    placeholder="Search by repository name..."
                    value="{{ search or '' }}"
                    hx-get="/admin/partials/jobs-list"
                    hx-target="#jobs-list-section"
                    hx-swap="innerHTML"
                    hx-trigger="keyup changed delay:300ms"
                    hx-include="#filter-form"
                >
            </div>

            <div class="filter-item filter-actions">
                <label>&nbsp;</label>
                <button type="button" class="outline" onclick="clearFilters()">Clear Filters</button>
            </div>
        </div>
    </form>
</section>

<!-- Jobs List Section -->
<section id="jobs-list-section">
    {% include "partials/jobs_list.html" %}
</section>

<!-- Auto-refresh for running jobs -->
<div id="auto-refresh-container" style="display: none;"
    hx-get="/admin/partials/jobs-list"
    hx-trigger="every 5s"
    hx-target="#jobs-list-section"
    hx-swap="innerHTML"
    hx-include="#filter-form">
</div>

<script>
// Track open details rows (Bug #751: state tracking to prevent auto-close)
let openDetailsSet = new Set();

function clearFilters() {
    document.getElementById('status_filter').value = '';
    document.getElementById('job_type').value = '';
    document.getElementById('search').value = '';
    // Trigger htmx request to refresh list
    htmx.ajax('GET', '/admin/partials/jobs-list', {target: '#jobs-list-section', swap: 'innerHTML'});
}

function confirmCancel(jobId, jobType) {
    if (confirm('Are you sure you want to cancel job "' + jobId.substring(0, 8) + '..." (' + jobType + ')? This action cannot be undone.')) {
        document.getElementById('cancel-form-' + jobId).submit();
    }
}

function toggleDetails(jobId) {
    const details = document.getElementById('details-' + jobId);
    if (details) {
        const isHidden = details.style.display === 'none';
        details.style.display = isHidden ? 'table-row' : 'none';
        // Track open/closed state (Bug #751)
        if (isHidden) {
            openDetailsSet.add(jobId);
        } else {
            openDetailsSet.delete(jobId);
        }
    }
}

function restoreOpenDetails() {
    // Restore previously open details rows after content refresh (Bug #751)
    if (openDetailsSet.size > 0) {
        openDetailsSet.forEach(jobId => {
            const details = document.getElementById('details-' + jobId);
            if (details) {
                details.style.display = 'table-row';
            }
        });
    }
}

// Enable auto-refresh when there are running/queued jobs
function checkForActiveJobs() {
    const runningIndicators = document.querySelectorAll('.status-running, .status-queued');
    const autoRefreshContainer = document.getElementById('auto-refresh-container');
    if (runningIndicators.length > 0) {
        autoRefreshContainer.style.display = 'block';
    } else {
        autoRefreshContainer.style.display = 'none';
    }
}

// Check on page load
document.addEventListener('DOMContentLoaded', checkForActiveJobs);

// Check after htmx swaps and restore open details (Bug #751)
document.body.addEventListener('htmx:afterSettle', function(event) {
    const target = event.detail.target;
    if (target && target.id === 'jobs-list-section') {
        checkForActiveJobs();
        // Use requestAnimationFrame to ensure DOM is fully ready
        requestAnimationFrame(() => {
            restoreOpenDetails();
        });
    } else {
        checkForActiveJobs();
    }
});
</script>
{% endblock %}
