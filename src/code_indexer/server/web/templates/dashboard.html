{% extends "base.html" %}

{% block title %}Dashboard - CIDX Admin{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Dashboard</h1>
    <div class="dashboard-actions">
        <button
            id="refresh-btn"
            class="outline"
            hx-get="/admin/partials/dashboard-health"
            hx-target="#health-section"
            hx-swap="innerHTML"
            onclick="refreshAll()"
        >
            Refresh
        </button>
    </div>
</div>

<p>Welcome, <strong>{{ username }}</strong>!</p>

<!-- System Health Section - Story #30 AC5: HTMX lazy-load -->
<section id="health-section" class="dashboard-section"
    hx-get="/admin/partials/dashboard-health"
    hx-trigger="load"
    hx-swap="innerHTML">
    <!-- Loading indicator shown until HTMX fetches health data -->
    <div class="loading-indicator">
        <h2>System Health</h2>
        <p>Loading health data...</p>
    </div>
</section>

<!-- Statistics Section -->
<section id="stats-section" class="dashboard-section">
    {% include "partials/dashboard_stats.html" %}
</section>

<script>
let autoRefreshInterval = null;

function refreshAll() {
    // Story #69: Surgical DOM updates - refresh ONLY data sections, not dropdowns

    // Refresh health section (unchanged)
    htmx.ajax('GET', '/admin/partials/dashboard-health', {target: '#health-section', swap: 'innerHTML'});

    // Preserve current filter selections during auto-refresh
    // Use optional chaining because elements may not exist on first page load
    const timeFilter = document.getElementById('time-filter')?.value || '24h';
    const apiFilter = document.getElementById('api-filter')?.value || '60';

    // Story #69: Granular refresh targets - dropdowns stay untouched
    htmx.ajax('GET', `/admin/partials/dashboard-job-counts?time_filter=${timeFilter}`, {
        target: '#job-counts-data',
        swap: 'innerHTML'
    });

    // Story #201: Recent Activity hardcoded to 24h (no dropdown)
    htmx.ajax('GET', '/admin/partials/dashboard-recent-jobs?recent_filter=24h', {
        target: '#recent-jobs-tbody',
        swap: 'innerHTML'
    });

    htmx.ajax('GET', `/admin/partials/dashboard-api-metrics?api_filter=${apiFilter}`, {
        target: '#api-metrics-data',
        swap: 'innerHTML'
    });
}

// Start auto-refresh on page load (every 2 seconds for responsive metrics)
document.addEventListener('DOMContentLoaded', function() {
    autoRefreshInterval = setInterval(refreshAll, 2000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}
