{% extends "base.html" %}

{% block title %}Auto-Discovery - CIDX Admin{% endblock %}

{% block content %}
<!-- Hidden CSRF token for JavaScript access -->
<input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token }}">

<div class="auto-discovery-header">
    <h1>Repository Auto-Discovery</h1>
    <p class="subtitle">Discover repositories from GitLab and GitHub to add as golden repos</p>
</div>

<!-- Selection Summary Bar -->
<div id="selection-bar" class="selection-bar" style="display: none;">
    <span id="selection-count">0 repositories selected</span>
    <div class="selection-actions">
        <button onclick="clearSelection()" class="outline small">Clear Selection</button>
        <button onclick="showCreateDialog()" class="small" id="create-btn" disabled>
            Create Golden Repos
        </button>
    </div>
</div>

<!-- Batch Create Modal -->
<dialog id="batch-create-modal">
    <article>
        <header>
            <h3>Create Golden Repositories</h3>
            <button type="button" class="close-btn" aria-label="Close" onclick="closeBatchModal()">&times;</button>
        </header>
        <p>Select the branch to use for each repository:</p>
        <div id="batch-repo-list" class="batch-repo-list">
            <!-- Populated dynamically with branch dropdowns -->
        </div>
        <footer>
            <button onclick="closeBatchModal()" class="outline">Cancel</button>
            <button onclick="executeBatchCreate()" class="primary" id="execute-batch-btn">
                Create <span id="batch-count">0</span> Repositories
            </button>
        </footer>
    </article>
</dialog>

<!-- GitLab Section -->
<section class="discovery-section">
    <div class="section-header">
        <h2>GitLab Repositories</h2>
        <div class="section-actions">
            <button
                id="refresh-gitlab-btn"
                class="outline"
                hx-get="/admin/partials/auto-discovery/gitlab"
                hx-target="#gitlab-repos-section"
                hx-swap="innerHTML"
                hx-indicator="#gitlab-refresh-indicator"
            >
                Refresh
            </button>
            <span id="gitlab-refresh-indicator" class="htmx-indicator">Loading...</span>
        </div>
    </div>

    <!-- GitLab Repositories List (loaded via HTMX) -->
    <div id="gitlab-repos-section"
        hx-get="/admin/partials/auto-discovery/gitlab"
        hx-trigger="load"
        hx-swap="innerHTML"
        hx-indicator="#gitlab-load-indicator">
        <div class="loading-container">
            <span id="gitlab-load-indicator" class="htmx-indicator">Loading GitLab repositories...</span>
        </div>
    </div>
</section>

<!-- GitHub Section -->
<section class="discovery-section">
    <div class="section-header">
        <h2>GitHub Repositories</h2>
        <div class="section-actions">
            <button
                id="refresh-github-btn"
                class="outline"
                hx-get="/admin/partials/auto-discovery/github"
                hx-target="#github-repos-section"
                hx-swap="innerHTML"
                hx-indicator="#github-refresh-indicator"
            >
                Refresh
            </button>
            <span id="github-refresh-indicator" class="htmx-indicator">Loading...</span>
        </div>
    </div>

    <!-- GitHub Repositories List (loaded via HTMX) -->
    <div id="github-repos-section"
        hx-get="/admin/partials/auto-discovery/github"
        hx-trigger="load"
        hx-swap="innerHTML"
        hx-indicator="#github-load-indicator">
        <div class="loading-container">
            <span id="github-load-indicator" class="htmx-indicator">Loading GitHub repositories...</span>
        </div>
    </div>
</section>

<script>
// Global selection state (persists across pagination/search)
const selectedRepos = new Map();  // key: clone_url, value: {platform, name, branch}

function toggleSelectAll(platform, checked) {
    document.querySelectorAll('input[data-platform="' + platform + '"]')
        .forEach(function(checkbox) {
            checkbox.checked = checked;
            updateRepoSelection(checkbox);
        });
    updateSelectionUI();
}

function updateRepoSelection(checkbox) {
    var url = checkbox.value;
    if (checkbox.checked) {
        selectedRepos.set(url, {
            platform: checkbox.dataset.platform,
            name: checkbox.dataset.name,
            branch: checkbox.dataset.branch
        });
    } else {
        selectedRepos.delete(url);
    }
}

function updateSelectionUI() {
    var count = selectedRepos.size;
    document.getElementById('selection-count').textContent = count + ' repositor' + (count === 1 ? 'y' : 'ies') + ' selected';
    document.getElementById('selection-bar').style.display = count > 0 ? 'flex' : 'none';
    document.getElementById('create-btn').disabled = count === 0;
}

// Restore selections after HTMX swap
document.body.addEventListener('htmx:afterSettle', restoreSelections);

function restoreSelections() {
    document.querySelectorAll('input.repo-checkbox').forEach(function(checkbox) {
        checkbox.checked = selectedRepos.has(checkbox.value);
    });
    updateSelectionUI();
}

function clearSelection() {
    selectedRepos.clear();
    document.querySelectorAll('input.repo-checkbox').forEach(function(cb) {
        cb.checked = false;
    });
    document.querySelectorAll('#select-all-gitlab, #select-all-github').forEach(function(cb) {
        cb.checked = false;
    });
    updateSelectionUI();
}

async function showCreateDialog() {
    var modal = document.getElementById('batch-create-modal');
    var list = document.getElementById('batch-repo-list');
    var countSpan = document.getElementById('batch-count');

    // Defensive null checks for DOM elements
    if (!modal || !list || !countSpan) {
        console.error('showCreateDialog: Required elements not found', {
            modal: !!modal,
            list: !!list,
            countSpan: !!countSpan
        });
        alert('Error: Dialog elements not found. Please refresh the page (Ctrl+Shift+R).');
        return;
    }

    // Clear and show loading state
    list.innerHTML = '';
    countSpan.textContent = selectedRepos.size;

    // Build initial list with loading spinners
    selectedRepos.forEach(function(data, url) {
        var item = document.createElement('div');
        item.className = 'batch-repo-item';
        item.dataset.url = url;
        item.innerHTML =
            '<div class="repo-info">' +
                '<span class="repo-platform">' + data.platform.toUpperCase() + '</span>' +
                '<span class="repo-name">' + data.name + '</span>' +
            '</div>' +
            '<div class="branch-select-container">' +
                '<span class="branch-loading">Loading branches...</span>' +
            '</div>';
        list.appendChild(item);
    });

    modal.showModal();

    // Fetch branches for all selected repos
    await fetchBranchesForSelectedRepos();
}

async function fetchBranchesForSelectedRepos() {
    // Build request with all selected repos
    var repos = [];
    selectedRepos.forEach(function(data, url) {
        repos.push({
            clone_url: url,
            platform: data.platform
        });
    });

    if (repos.length === 0) return;

    try {
        var response = await fetch('/admin/api/discovery/branches', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ repos: repos })
        });

        if (!response.ok) {
            throw new Error('Failed to fetch branches: ' + response.status);
        }

        var results = await response.json();

        // Update each repo item with branches or error
        selectedRepos.forEach(function(data, url) {
            var result = results[url];
            updateRepoBranchDropdown(url, data, result);
        });

    } catch (error) {
        console.error('Error fetching branches:', error);
        // Show error for all repos
        selectedRepos.forEach(function(data, url) {
            updateRepoBranchDropdown(url, data, {
                branches: [],
                default_branch: null,
                error: error.message
            });
        });
    }
}

function updateRepoBranchDropdown(url, repoData, branchResult) {
    var item = document.querySelector('.batch-repo-item[data-url="' + CSS.escape(url) + '"]');
    if (!item) return;

    var container = item.querySelector('.branch-select-container');
    if (!container) return;

    if (branchResult.error) {
        // Show error with fallback to default branch
        container.innerHTML =
            '<div class="branch-error">' +
                '<span class="error-msg" title="' + branchResult.error + '">Error loading branches</span>' +
                '<span class="branch-fallback">Using: ' + repoData.branch + '</span>' +
            '</div>';
    } else if (branchResult.branches.length === 0) {
        // No branches found, use default
        container.innerHTML =
            '<span class="branch-fallback">Branch: ' + repoData.branch + '</span>';
    } else {
        // Show dropdown with branches
        var select = document.createElement('select');
        select.className = 'branch-select';
        select.dataset.url = url;
        select.onchange = function() { onBranchChange(url, this.value); };

        // Determine which branch to select by default
        var defaultBranch = branchResult.default_branch || repoData.branch;

        branchResult.branches.forEach(function(branch) {
            var option = document.createElement('option');
            option.value = branch;
            option.textContent = branch;
            if (branch === defaultBranch) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // If default branch not in list, add it at top
        if (defaultBranch && !branchResult.branches.includes(defaultBranch)) {
            var option = document.createElement('option');
            option.value = defaultBranch;
            option.textContent = defaultBranch + ' (default)';
            option.selected = true;
            select.insertBefore(option, select.firstChild);
        }

        container.innerHTML = '';
        container.appendChild(select);

        // Update selectedRepos with the selected branch
        var selectedBranch = select.value;
        if (selectedBranch !== repoData.branch) {
            selectedRepos.set(url, {
                ...repoData,
                branch: selectedBranch
            });
        }
    }
}

function onBranchChange(url, newBranch) {
    var data = selectedRepos.get(url);
    if (data) {
        selectedRepos.set(url, {
            ...data,
            branch: newBranch
        });
    }
}

function closeBatchModal() {
    document.getElementById('batch-create-modal').close();
}

async function executeBatchCreate() {
    var repos = [];
    selectedRepos.forEach(function(data, url) {
        repos.push({
            clone_url: url,
            alias: data.name,
            branch: data.branch,
            platform: data.platform
        });
    });

    var formData = new FormData();
    formData.append('repos', JSON.stringify(repos));

    // Get CSRF token from cookie or form
    var csrfToken = getCsrfToken();
    if (csrfToken) {
        formData.append('csrf_token', csrfToken);
    }

    // Disable button during request
    var executeBtn = document.getElementById('execute-batch-btn');
    executeBtn.disabled = true;
    executeBtn.innerHTML = 'Creating...';

    try {
        var response = await fetch('/admin/golden-repos/batch-create', {
            method: 'POST',
            body: formData
        });
        var result = await response.json();

        closeBatchModal();
        clearSelection();

        // Show result message
        showNotification(result.summary, result.success ? 'success' : 'warning');

        // Reload discovery to update exclusions
        htmx.ajax('GET', '/admin/partials/auto-discovery/gitlab?page=1', {target: '#gitlab-repos-section', swap: 'innerHTML'});
        htmx.ajax('GET', '/admin/partials/auto-discovery/github?page=1', {target: '#github-repos-section', swap: 'innerHTML'});
    } catch (error) {
        showNotification('Error creating repositories: ' + error.message, 'error');
    } finally {
        executeBtn.disabled = false;
        executeBtn.innerHTML = 'Create <span id="batch-count">' + selectedRepos.size + '</span> Repositories';
    }
}

function getCsrfToken() {
    // Try to get CSRF token from a form on the page or from cookie
    var csrfInput = document.querySelector('input[name="csrf_token"]');
    if (csrfInput) {
        return csrfInput.value;
    }
    // Try to parse from cookie
    var match = document.cookie.match(/(?:^|; )_csrf=([^;]*)/);
    return match ? decodeURIComponent(match[1]) : null;
}

function showNotification(message, type) {
    // Simple alert for now - can be enhanced with toast notifications
    alert(message);
}

function retryGitLabDiscovery() {
    htmx.ajax('GET', '/admin/partials/auto-discovery/gitlab', {target: '#gitlab-repos-section', swap: 'innerHTML'});
}

function loadGitLabPage(page, pageSize) {
    htmx.ajax('GET', '/admin/partials/auto-discovery/gitlab?page=' + page + '&page_size=' + pageSize, {target: '#gitlab-repos-section', swap: 'innerHTML'});
}

function retryGitHubDiscovery() {
    htmx.ajax('GET', '/admin/partials/auto-discovery/github', {target: '#github-repos-section', swap: 'innerHTML'});
}

function loadGitHubPage(page, pageSize) {
    htmx.ajax('GET', '/admin/partials/auto-discovery/github?page=' + page + '&page_size=' + pageSize, {target: '#github-repos-section', swap: 'innerHTML'});
}
</script>

<style>
/* Selection bar styles */
.selection-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background-color: var(--primary-focus, #e3f2fd);
    border: 1px solid var(--primary, #1976d2);
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.selection-bar span {
    font-weight: 500;
    color: var(--primary, #1976d2);
}

.selection-actions {
    display: flex;
    gap: 0.5rem;
}

/* Batch modal styles */
#batch-create-modal {
    max-width: 600px;
    width: 90%;
}

#batch-create-modal article {
    margin: 0;
}

#batch-create-modal header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--muted-border-color);
}

#batch-create-modal header h3 {
    margin: 0;
}

#batch-create-modal .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    color: var(--muted-color);
}

#batch-create-modal .close-btn:hover {
    color: var(--color);
}

.batch-repo-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 1rem 0;
    padding: 0;
}

.batch-repo-item {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    padding: 0.75rem;
    border-bottom: 1px solid var(--muted-border-color, #e0e0e0);
    gap: 0.5rem;
}

.batch-repo-item:last-child {
    border-bottom: none;
}

.repo-info {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.repo-platform {
    font-size: 0.75rem;
    color: var(--muted-color, #666);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.repo-name {
    font-weight: 500;
    word-break: break-all;
    line-height: 1.3;
}

.branch-select-container {
    width: 100%;
}

.branch-loading {
    color: var(--muted-color, #666);
    font-size: 0.85rem;
    font-style: italic;
}

.branch-select {
    width: 100%;
    padding: 0.4rem 0.6rem;
    font-size: 0.9rem;
    border: 1px solid var(--muted-border-color, #ccc);
    border-radius: 4px;
    background-color: var(--background-color, #fff);
    color: var(--color, #1a1a1a);
    cursor: pointer;
}

.branch-select:focus {
    outline: none;
    border-color: var(--primary, #1976d2);
    box-shadow: 0 0 0 2px var(--primary-focus, rgba(25, 118, 210, 0.2));
}

.branch-error {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
}

.branch-error .error-msg {
    color: var(--del-color, #dc3545);
    font-size: 0.8rem;
    cursor: help;
}

.branch-fallback {
    font-size: 0.85rem;
    color: var(--muted-color, #666);
}

#batch-create-modal footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--muted-border-color);
}

.auto-discovery-header {
    margin-bottom: 2rem;
}

.auto-discovery-header h1 {
    margin-bottom: 0.5rem;
}

.auto-discovery-header .subtitle {
    color: var(--muted-color);
    margin: 0;
}

.discovery-section {
    margin-bottom: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h2 {
    margin: 0;
}

.section-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.loading-container {
    text-align: center;
    padding: 2rem;
}
</style>
{% endblock %}
