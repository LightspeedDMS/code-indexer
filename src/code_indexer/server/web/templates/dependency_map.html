{% extends "base.html" %}

{% block content %}
<!-- D3.js v7 for dependency graph visualization (Story #215) -->
<script defer src="/admin/static/js/d3.v7.min.js"></script>
<script defer src="/admin/static/js/dependency_map.js"></script>

<h1>Dependency Map</h1>

{% if is_admin %}
<!-- AC2: Job Status section - admin only -->
<!-- AC5: HTMX lazy loads the partial on page load; auto-refresh driven by partial itself -->
<section id="depmap-job-status"
         hx-get="/admin/partials/depmap-job-status"
         hx-trigger="load"
         hx-swap="innerHTML">
    <p aria-busy="true">Loading job status...</p>
</section>

<!-- Story #329: Activity Journal Panel - independent from job-status 5s refresh cycle -->
<!-- Always present in DOM; shown/hidden by JS based on journal polling headers -->
<article id="depmap-activity-panel" style="display: none; margin-top: 1rem;">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Activity Journal</h3>
            <span id="depmap-progress-text"
                  style="font-size: 0.85rem; color: var(--pico-muted-color);">
            </span>
        </div>
        <!-- Progress bar -->
        <div style="margin-top: 0.5rem; background: var(--pico-secondary-background);
                    border-radius: 4px; height: 8px; overflow: hidden;">
            <div id="depmap-progress-bar"
                 style="height: 100%; background: var(--pico-primary);
                        border-radius: 4px; transition: width 0.3s ease;
                        width: 0%;">
            </div>
        </div>
        <div style="text-align: right; font-size: 0.75rem;
                    color: var(--pico-muted-color); margin-top: 2px;">
            <span id="depmap-progress-pct">0%</span>
        </div>
    </header>

    <!-- Scrolling journal entries -->
    <div id="depmap-journal-scroll"
         style="max-height: 400px; overflow-y: auto; padding: 0.5rem;
                font-family: monospace; font-size: 0.8rem; line-height: 1.5;
                background: var(--pico-card-background-color); border-radius: 4px;">
        <div id="depmap-activity-entries"
             hx-get="/admin/partials/depmap-activity-journal?offset=0"
             hx-swap="beforeend">
        </div>
    </div>
</article>

<script>
(function() {
    // Guard: only register once even if script block is somehow evaluated multiple times
    if (window._depmapJournalListenerRegistered) return;
    window._depmapJournalListenerRegistered = true;

    var SCROLL_THRESHOLD = 50;
    var wasNearBottom = true;

    function getScrollContainer() {
        return document.getElementById('depmap-journal-scroll');
    }

    function isNearBottom() {
        var sc = getScrollContainer();
        if (!sc) return true;
        return sc.scrollHeight - sc.scrollTop - sc.clientHeight < SCROLL_THRESHOLD;
    }

    function showPanel() {
        var panel = document.getElementById('depmap-activity-panel');
        if (panel) panel.style.display = '';
    }

    function hidePanel() {
        var panel = document.getElementById('depmap-activity-panel');
        if (panel) panel.style.display = 'none';
    }

    function updateProgressUI(progressPct, progressInfo) {
        if (progressPct !== null && progressPct !== undefined) {
            var bar = document.getElementById('depmap-progress-bar');
            if (bar) bar.style.width = progressPct + '%';
            var pct = document.getElementById('depmap-progress-pct');
            if (pct) pct.textContent = progressPct + '%';
        }
        if (progressInfo) {
            var info = document.getElementById('depmap-progress-text');
            if (info) info.textContent = decodeURIComponent(progressInfo);
        }
    }

    // Capture scroll position BEFORE HTMX swap to avoid race condition
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        if (evt.detail.target && evt.detail.target.id === 'depmap-activity-entries') {
            wasNearBottom = isNearBottom();
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        // Handle trigger button responses (Full Analysis / Delta Refresh)
        if (evt.detail.elt.hasAttribute('hx-post') &&
            evt.detail.elt.getAttribute('hx-post') === '/admin/dependency-map/trigger') {
            var statusDiv = document.getElementById('depmap-trigger-status');
            if (statusDiv) {
                if (evt.detail.successful) {
                    statusDiv.innerHTML = '<span style="color: var(--pico-color-green-550);">Analysis triggered</span>';

                    // Reset journal entries and offset on new trigger
                    var entriesEl = document.getElementById('depmap-activity-entries');
                    if (entriesEl) {
                        entriesEl.innerHTML = '';
                        entriesEl.setAttribute('hx-get',
                            '/admin/partials/depmap-activity-journal?offset=0');
                        entriesEl.setAttribute('hx-trigger', 'every 3s');
                        htmx.process(entriesEl);
                    }
                    showPanel();

                    // Reset progress bar
                    updateProgressUI(0, '');

                    // Refresh job status after 3 seconds
                    setTimeout(function() {
                        htmx.ajax('GET', '/admin/partials/depmap-job-status', {
                            target: '#depmap-job-status',
                            swap: 'innerHTML'
                        });
                    }, 3000);
                } else {
                    statusDiv.innerHTML = '<span style="color: var(--pico-color-red-550);">Failed to trigger analysis</span>';
                }

                // Clear status after 8 seconds
                setTimeout(function() {
                    statusDiv.innerHTML = '';
                }, 8000);
            }
            return;
        }

        // Handle journal polling responses
        var path = evt.detail.pathInfo && evt.detail.pathInfo.requestPath;
        if (path && path.indexOf('depmap-activity-journal') !== -1) {
            var xhr = evt.detail.xhr;
            var newOffset = xhr.getResponseHeader('X-Journal-Offset');
            var progressPct = xhr.getResponseHeader('X-Journal-Progress');
            var progressInfo = xhr.getResponseHeader('X-Journal-Progress-Info');

            // Update offset for next poll
            if (newOffset !== null) {
                var entriesEl = document.getElementById('depmap-activity-entries');
                if (entriesEl) {
                    entriesEl.setAttribute('hx-get',
                        '/admin/partials/depmap-activity-journal?offset=' + newOffset);
                    htmx.process(entriesEl);
                }
            }

            // Update progress UI
            updateProgressUI(progressPct, progressInfo);

            // Show/hide panel based on active state
            var isActive = xhr.getResponseHeader('X-Journal-Active');
            var entriesContainer = document.getElementById('depmap-activity-entries');
            var hasEntries = entriesContainer && entriesContainer.children.length > 0;

            if (isActive === '1') {
                // Job is running - show panel if there's any content
                if (hasEntries) {
                    showPanel();
                }
            } else {
                // Job NOT running (completed or never started)
                if (hasEntries) {
                    // Show completion state briefly, then hide
                    updateProgressUI(100, 'Complete');
                    // Stop polling immediately
                    var stopEl = document.getElementById('depmap-activity-entries');
                    if (stopEl) {
                        stopEl.removeAttribute('hx-trigger');
                        htmx.process(stopEl);
                    }
                    // Hide panel after 8 seconds so user can read final entries
                    setTimeout(function() {
                        hidePanel();
                    }, 8000);
                } else {
                    // No entries and not running - ensure panel is hidden and polling stopped
                    hidePanel();
                    var stopEl2 = document.getElementById('depmap-activity-entries');
                    if (stopEl2 && stopEl2.hasAttribute('hx-trigger')) {
                        stopEl2.removeAttribute('hx-trigger');
                        htmx.process(stopEl2);
                    }
                }
            }
        }
    });

    // Auto-scroll journal when new entries arrive
    var observer = new MutationObserver(function() {
        if (wasNearBottom) {
            var sc = getScrollContainer();
            if (sc) sc.scrollTop = sc.scrollHeight;
        }
    });

    // Observe entries container - it exists in DOM at page load
    var entriesContainer = document.getElementById('depmap-activity-entries');
    if (entriesContainer) {
        observer.observe(entriesContainer, { childList: true, subtree: true });
    }
})();
</script>
{% endif %}

<!-- AC1: Repository Coverage section - HTMX lazy loads partial for all authenticated users -->
<section id="depmap-repo-coverage"
         hx-get="/admin/partials/depmap-repo-coverage"
         hx-trigger="load"
         hx-swap="innerHTML">
    <p aria-busy="true">Loading repository coverage...</p>
</section>

<section id="depmap-domains"
         hx-get="/admin/partials/depmap-domain-explorer"
         hx-trigger="load"
         hx-swap="innerHTML">
    <p aria-busy="true">Loading domain explorer...</p>
</section>
{% endblock %}
